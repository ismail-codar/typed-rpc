{"version":3,"file":"ws.cjs","sources":["../../src/transporters/ws.ts"],"sourcesContent":["import {\r\n  type JsonRpcResponse,\r\n  type RpcTransport,\r\n  isJsonRpcResponse,\r\n} from \"../client.js\";\r\n\r\nexport type WebSocketTransportOptions = {\r\n  /**\r\n   * The URL to connect to.\r\n   */\r\n  url: string;\r\n  /**\r\n   * Reconnection timeout in milliseconds. Default is 1000ms.\r\n   * Set to 0 to disable reconnection.\r\n   */\r\n  reconnectTimeout?: number;\r\n  /**\r\n   * The timeout in milliseconds for requests.\r\n   * Default is 60_000ms.\r\n   */\r\n  timeout?: number;\r\n  /**\r\n   * Error handler for incoming messages.\r\n   */\r\n  onMessageError?: (err: unknown) => void;\r\n  /**\r\n   * WebSocket open handler.\r\n   * Use to access the WebSocket instance.\r\n   */\r\n  onOpen?: (ev: Event, ws: WebSocket) => void;\r\n};\r\n\r\ntype PendingResponse = {\r\n  resolve: (res: JsonRpcResponse) => void;\r\n  reject: (err: Error) => void;\r\n  timeoutId?: ReturnType<typeof setTimeout>;\r\n};\r\n\r\nexport function websocketTransport(\r\n  options: WebSocketTransportOptions\r\n): RpcTransport {\r\n  const pendingResponses = new Map<string | number, PendingResponse>();\r\n  const timeout = options.timeout ?? 60_000;\r\n\r\n  let wsPromise: Promise<WebSocket>;\r\n\r\n  function connect() {\r\n    wsPromise = new Promise((resolve, reject) => {\r\n      const ws = new WebSocket(options.url);\r\n      ws.addEventListener(\"open\", (ev) => {\r\n        options.onOpen?.(ev, ws);\r\n        resolve(ws);\r\n      });\r\n      ws.addEventListener(\r\n        \"error\",\r\n        (ev: any) => {\r\n          ws.close();\r\n          reject(ev.error);\r\n        },\r\n        { once: true }\r\n      );\r\n\r\n      ws.addEventListener(\"message\", (ev) => {\r\n        let res: unknown;\r\n        try {\r\n          res = JSON.parse(ev.data.toString());\r\n        } catch (err) {\r\n          options.onMessageError?.(err);\r\n          return;\r\n        }\r\n        if (!isJsonRpcResponse(res)) {\r\n          options.onMessageError?.(new TypeError(\"Invalid response\"));\r\n          return;\r\n        }\r\n        if (res.id === null) {\r\n          // Ignore notifications\r\n          return;\r\n        }\r\n        const pending = pendingResponses.get(res.id!);\r\n        if (!pending) {\r\n          options.onMessageError?.(\r\n            new Error(\"Request not found for id: \" + res.id)\r\n          );\r\n          return;\r\n        }\r\n\r\n        pendingResponses.delete(res.id!);\r\n        if (pending.timeoutId) {\r\n          clearTimeout(pending.timeoutId);\r\n        }\r\n\r\n        pending.resolve(res);\r\n      });\r\n\r\n      ws.addEventListener(\"close\", (ev) => {\r\n        const reconnectTimeout = options.reconnectTimeout ?? 1000;\r\n        if (\r\n          reconnectTimeout !== 0 &&\r\n          (!ev.wasClean || ev.reason === \"reconnect\")\r\n        ) {\r\n          setTimeout(connect, reconnectTimeout);\r\n        }\r\n      });\r\n    });\r\n  }\r\n\r\n  connect();\r\n\r\n  return (req, signal): Promise<any> => {\r\n    const requestId = req.id ?? -1;\r\n    return new Promise((resolve, reject) => {\r\n      const pending: PendingResponse = { resolve, reject };\r\n\r\n      if (timeout > 0) {\r\n        pending.timeoutId = setTimeout(() => {\r\n          reject(new Error(\"Request timed out\", { cause: -32000 }));\r\n        }, timeout);\r\n      }\r\n\r\n      signal.onabort = () => {\r\n        if (pending.timeoutId) {\r\n          clearTimeout(pending.timeoutId);\r\n        }\r\n        reject(new Error(\"Request aborted\", { cause: -32000 }));\r\n      };\r\n\r\n      pendingResponses.set(requestId, pending);\r\n\r\n      wsPromise\r\n        .then((ws) => {\r\n          ws.send(JSON.stringify(req));\r\n        })\r\n        .catch((err) => {\r\n          pendingResponses.delete(requestId);\r\n          if (pending.timeoutId) {\r\n            clearTimeout(pending.timeoutId);\r\n          }\r\n          reject(err);\r\n        });\r\n    });\r\n  };\r\n}\r\n"],"names":["isJsonRpcResponse"],"mappings":"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"}
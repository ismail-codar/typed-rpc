{"version":3,"file":"client.cjs","sources":["../src/client.ts"],"sourcesContent":["import type {\r\n  JsonRpcErrorResponse,\r\n  JsonRpcRequest,\r\n  JsonRpcResponse,\r\n  RpcTranscoder,\r\n} from \"./types.js\";\r\n\r\nexport * from \"./types.js\";\r\n\r\n/**\r\n * Type guard to check if a given object is a valid JSON-RPC response.\r\n */\r\nexport function isJsonRpcResponse(res: unknown): res is JsonRpcResponse {\r\n  if (typeof res !== \"object\" || res === null) return false;\r\n  if (!(\"jsonrpc\" in res) || res.jsonrpc !== \"2.0\") return false;\r\n  if (\r\n    !(\"id\" in res) ||\r\n    (typeof res.id !== \"string\" &&\r\n      typeof res.id !== \"number\" &&\r\n      res.id !== null)\r\n  )\r\n    return false;\r\n\r\n  if (\"result\" in res) {\r\n    // Check for JsonRpcSuccessResponse\r\n    return !(\"error\" in res);\r\n  } else if (\"error\" in res) {\r\n    // Check for JsonRpcErrorResponse\r\n    const error = (res as JsonRpcErrorResponse).error;\r\n    return (\r\n      typeof error === \"object\" &&\r\n      error !== null &&\r\n      \"code\" in error &&\r\n      typeof error.code === \"number\" &&\r\n      \"message\" in error &&\r\n      typeof error.message === \"string\"\r\n    );\r\n  }\r\n\r\n  return false;\r\n}\r\n\r\n/**\r\n * Interface for custom transports. Implementations are expected to serialize\r\n * the given request and return an object that is a JsonRpcResponse.\r\n */\r\nexport type RpcTransport = (\r\n  req: JsonRpcRequest,\r\n  abortSignal: AbortSignal,\r\n  onEventCallback?: (data: JsonRpcResponse & { result: any }) => void\r\n) => Promise<JsonRpcResponse>;\r\n\r\nexport type ErrorFunctionType = (data: {\r\n  code: string;\r\n  message?: string;\r\n  data?: any;\r\n}) => void;\r\ntype RpcClientOptions = {\r\n  transport: RpcTransport;\r\n  transcoder?: RpcTranscoder<any>;\r\n  onError?: ErrorFunctionType;\r\n};\r\n\r\ntype Promisify<T> = T extends (...args: any[]) => Promise<any>\r\n  ? T // already a promise\r\n  : T extends (...args: infer A) => infer R\r\n  ? (...args: A) => Promise<R>\r\n  : T; // not a function;\r\n\r\ntype PromisifyMethods<T extends object> = {\r\n  [K in keyof T]: Promisify<T[K]>;\r\n};\r\n\r\nconst identityTranscoder: RpcTranscoder<any> = {\r\n  serialize: (data) => data,\r\n  deserialize: (data) => data,\r\n};\r\n\r\nexport function rpcClient<T extends object>(options: RpcClientOptions) {\r\n  const transport = options.transport;\r\n  const { serialize, deserialize } = options.transcoder || identityTranscoder;\r\n\r\n  /**\r\n   * Send a request using the configured transport and handle the result.\r\n   */\r\n  const sendRequest = async (\r\n    method: string,\r\n    args: any[],\r\n    signal: AbortSignal\r\n  ) => {\r\n    const rpcEventCallbacks: Function[] = [];\r\n    if (method === \"events.on\") {\r\n      rpcEventCallbacks.push(args[1]);\r\n      args[1] = { $cb_fn: rpcEventCallbacks.length - 1 };\r\n    }\r\n    const req = createRequest(method, args);\r\n    const raw = await transport(serialize(req as any), signal, (cbData) => {\r\n      const fn = rpcEventCallbacks[cbData.result.$cb_fn];\r\n      fn.call(null, ...cbData.result.args);\r\n    });\r\n    const res = deserialize(raw);\r\n    if (\"result\" in res) {\r\n      return res.result;\r\n    } else if (\"error\" in res) {\r\n      const { code, message, data } = res.error;\r\n      if (options.onError) options.onError({ code, message, data });\r\n      else console.error({ code, message, data });\r\n    }\r\n    if (options.onError) options.onError({ code: \"INVALID_RESPONSE\" });\r\n    else console.error(\"INVALID_RESPONSE\");\r\n  };\r\n\r\n  // Map of AbortControllers to abort pending requests\r\n  const abortControllers = new WeakMap<Promise<any>, AbortController>();\r\n\r\n  const target = {\r\n    /**\r\n     * Abort the request for the given promise.\r\n     */\r\n    $abort: (promise: Promise<any>) => {\r\n      const ac = abortControllers.get(promise);\r\n      ac?.abort();\r\n    },\r\n  };\r\n\r\n  function ClientProxy(path: string) {\r\n    return new Proxy(() => {}, {\r\n      get: function (_, prop) {\r\n        return ClientProxy(`${path ? `${path}.` : \"\"}${String(prop)}`);\r\n      },\r\n      apply: function (_, __, args) {\r\n        const ac = new AbortController();\r\n        const promise = sendRequest(path.toString(), args, ac.signal);\r\n        abortControllers.set(promise, ac);\r\n        promise\r\n          .finally(() => {\r\n            abortControllers.delete(promise);\r\n          })\r\n          .catch(() => {});\r\n        return promise;\r\n      },\r\n    }) as any as typeof target & PromisifyMethods<T>;\r\n  }\r\n\r\n  return ClientProxy(\"\");\r\n}\r\n\r\n/**\r\n * Create a JsonRpcRequest for the given method.\r\n */\r\nexport function createRequest(method: string, params?: any[]): JsonRpcRequest {\r\n  const req: JsonRpcRequest = {\r\n    jsonrpc: \"2.0\",\r\n    id: Date.now(),\r\n    method,\r\n  };\r\n\r\n  if (params?.length) {\r\n    req.params = removeTrailingUndefs(params);\r\n  }\r\n\r\n  return req;\r\n}\r\n\r\n/**\r\n * Returns a shallow copy the given array without any\r\n * trailing `undefined` values.\r\n */\r\nexport function removeTrailingUndefs(values: any[]) {\r\n  const a = [...values];\r\n  while (a.length && a[a.length - 1] === undefined) a.length--;\r\n  return a;\r\n}\r\n"],"names":[],"mappings":"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"}
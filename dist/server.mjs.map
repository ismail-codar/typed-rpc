{"version":3,"file":"server.mjs","sources":["../src/server.ts"],"sourcesContent":["import type {\r\n  JsonRpcRequest,\r\n  JsonRpcErrorResponse,\r\n  JsonRpcSuccessResponse,\r\n  RpcTranscoder,\r\n  JsonRpcResponse,\r\n} from \"./types.js\";\r\n\r\nexport * from \"./types.js\";\r\n\r\n/**\r\n * Type guard to check if a given object is a valid JSON-RPC request.\r\n */\r\nexport function isJsonRpcRequest(req: any): req is JsonRpcRequest {\r\n  if (req.jsonrpc !== \"2.0\") return false;\r\n  if (typeof req.method !== \"string\") return false;\r\n  if (!Array.isArray(req.params) && req.params !== undefined) return false;\r\n  return true;\r\n}\r\n\r\n/**\r\n * Type guard to check if an object has a certain property.\r\n */\r\nfunction hasProperty<T, P extends string>(\r\n  obj: T,\r\n  prop: P\r\n): obj is T & Record<P, unknown> {\r\n  return typeof obj === \"object\" && obj !== null && prop in obj;\r\n}\r\n\r\n/**\r\n * Type guard to check if an object has a certain method.\r\n */\r\nfunction hasMethod<T, P extends string>(\r\n  obj: T,\r\n  prop: P\r\n): obj is T & Record<P, (...params: any[]) => any> {\r\n  return hasProperty(obj, prop) && typeof obj[prop] === \"function\";\r\n}\r\n\r\nfunction getErrorCode(err: unknown) {\r\n  if (hasProperty(err, \"code\") && typeof err.code === \"number\") {\r\n    return err.code;\r\n  }\r\n  return -32000;\r\n}\r\n\r\nfunction getErrorMessage(err: unknown) {\r\n  if (hasProperty(err, \"message\") && typeof err.message === \"string\") {\r\n    return err.message;\r\n  }\r\n  return \"\";\r\n}\r\n\r\nfunction getErrorData(err: unknown) {\r\n  if (hasProperty(err, \"data\")) {\r\n    const stringifiedData = JSON.stringify(err.data);\r\n    if (stringifiedData !== undefined) {\r\n      err.data = JSON.parse(stringifiedData);\r\n    }\r\n    return err.data;\r\n  }\r\n}\r\n\r\n/**\r\n * Returns the id or null if there is no valid id.\r\n */\r\nfunction getRequestId(req: unknown) {\r\n  if (hasProperty(req, \"id\")) {\r\n    const id = req.id;\r\n    if (typeof id === \"string\" || typeof id === \"number\") return id;\r\n  }\r\n  return null;\r\n}\r\n\r\nexport type JsonValue =\r\n  | string\r\n  | number\r\n  | boolean\r\n  | null\r\n  | JsonValue[]\r\n  | { [key: string]: JsonValue };\r\n\r\n/**\r\n * Signature that all RPC methods must adhere to.\r\n */\r\nexport type RpcMethod<V = JsonValue> = (...args: any[]) => V | Promise<V>;\r\n\r\n/**\r\n * Conditional type to verify a given type is a valid RPC method.\r\n */\r\ntype ValidMethod<T, V> = T extends RpcMethod<V> ? T : never;\r\n\r\n/**\r\n * Conditional type to verify that a function is also a valid RPC method.\r\n */\r\ntype RpcServiceProp<T, V> = T extends (...args: any) => any\r\n  ? ValidMethod<T, V>\r\n  : T;\r\n\r\n/**\r\n * Type for RPC services that makes sure that all return values can\r\n * be serialized.\r\n */\r\nexport type RpcService<T, V> = { [K in keyof T]: RpcServiceProp<T[K], V> };\r\n\r\n/**\r\n * Options to customize the behavior of the RPC handler.\r\n */\r\nexport type RpcHandlerOptions<V> = {\r\n  transcoder?: RpcTranscoder<V>;\r\n  onError?: (err: unknown) => void;\r\n  getErrorCode?: (err: unknown) => number;\r\n  getErrorMessage?: (err: unknown) => string;\r\n  getErrorData?: (err: unknown) => unknown;\r\n  onEventEmit?: (data: JsonRpcResponse & { method: string }) => void;\r\n};\r\n\r\nfunction traverseJson(\r\n  jsonObj: any,\r\n  callback: (parent: any, key: string) => void\r\n) {\r\n  // Stack yapısı\r\n  const stack: any[] = [];\r\n\r\n  // Ana JSON objesi başlangıçta stack'e eklenir\r\n  stack.push({ parent: null, key: null, value: jsonObj });\r\n\r\n  // Stack boş olana kadar devam et\r\n  while (stack.length > 0) {\r\n    const current = stack.pop(); // Stack'ten en üstteki elemanı al\r\n    const { parent, key, value } = current; // Parent, key ve value'yu çıkar\r\n\r\n    // Callback'i çağır (ebeveyn obje ve anahtar için)\r\n    if (parent && key) callback(parent, key);\r\n\r\n    // Eğer obje veya dizi değilse (terminal bir düğüm) devam etme\r\n    if (typeof value !== \"object\" || value === null) {\r\n      continue;\r\n    }\r\n\r\n    // Obje veya dizinin her bir anahtarını işle\r\n    for (const childKey in value) {\r\n      if (value.hasOwnProperty(childKey)) {\r\n        stack.push({ parent: value, key: childKey, value: value[childKey] }); // Alt objeyi stack'e ekle\r\n      }\r\n    }\r\n  }\r\n}\r\nconst isoDateRegex =\r\n  /^(\\d{4})-(0[1-9]|1[0-2])-(0[1-9]|[12]\\d|3[01])(T([01]\\d|2[0-3]):([0-5]\\d):([0-5]\\d)(\\.\\d+)?(Z|([+-](0[0-9]|1[0-3]):[0-5]\\d))?)?$/;\r\nconst isoDateLengths = [10, 20, 24, 29];\r\nconst isIsoDate = (value: any) => {\r\n  return (\r\n    typeof value === \"string\" &&\r\n    isoDateLengths.includes(value.length) &&\r\n    isoDateRegex.test(value)\r\n  );\r\n};\r\n\r\nexport async function handleRpc<T extends RpcService<T, V>, V = JsonValue>(\r\n  request: JsonRpcRequest,\r\n  service: T,\r\n  options?: RpcHandlerOptions<V>\r\n): Promise<JsonRpcErrorResponse | JsonRpcSuccessResponse> {\r\n  const cb_fn = request.params?.[1];\r\n  if (\r\n    request.method === \"events.on\" &&\r\n    request.params &&\r\n    options?.onEventEmit\r\n  ) {\r\n    request.params[1] = (...args: any[]) => {\r\n      cb_fn.args = args;\r\n      options.onEventEmit?.({\r\n        jsonrpc: request.jsonrpc,\r\n        result: cb_fn,\r\n        id: request.id,\r\n        method: request.params?.[0],\r\n      });\r\n      return cb_fn;\r\n    };\r\n  }\r\n  const req = options?.transcoder?.deserialize(request) ?? request;\r\n  const id = getRequestId(req);\r\n  const res = (data: any) => {\r\n    const raw = {\r\n      jsonrpc: \"2.0\",\r\n      id,\r\n      ...data,\r\n    };\r\n    return options?.transcoder?.serialize(raw) ?? raw;\r\n  };\r\n\r\n  if (!isJsonRpcRequest(req)) {\r\n    //The JSON sent is not a valid Request object\r\n    return res({ error: { code: -32600, message: \"Invalid Request\" } });\r\n  }\r\n  const procedurePath = req.method.split(\".\");\r\n  const method = procedurePath.splice(-1, 1)[0];\r\n  for (const proc of procedurePath) {\r\n    // @ts-ignore\r\n    service = service[proc];\r\n  }\r\n  if (!hasMethod(service, method)) {\r\n    return res({\r\n      error: { code: -32601, message: `Method not found: ${method}` },\r\n    });\r\n  }\r\n  try {\r\n    const params = req.params ?? [];\r\n    traverseJson(params, (parent, key) => {\r\n      console.log(key);\r\n      if (isIsoDate(parent[key])) {\r\n        parent[key] = new Date(parent[key]);\r\n      }\r\n    });\r\n    if (req.extra) {\r\n      params.push(req.extra);\r\n    }\r\n    const result = await service[method](...params);\r\n    if (req.method === \"events.on\") {\r\n      return res({ result: cb_fn });\r\n    }\r\n    return res({ result });\r\n  } catch (err) {\r\n    if (options?.onError) {\r\n      options.onError(err);\r\n    }\r\n    return res({\r\n      error: {\r\n        code: (options?.getErrorCode ?? getErrorCode)(err),\r\n        message: (options?.getErrorMessage ?? getErrorMessage)(err),\r\n        data: (options?.getErrorData ?? getErrorData)(err),\r\n      },\r\n    });\r\n  }\r\n}\r\n"],"names":[],"mappings":"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"}